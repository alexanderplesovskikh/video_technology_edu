# Лекция 4. Видеокомпрессия

#### 1. Сжатие цифрового видео

- Цель: Понимание принципов сжатия видео и современных видеокодеков.
- Зачем: Борьба с ограничениями пропускной способности и хранилища данных.
- Различия между сжатием изображений и видео: В изображениях и в видео мы боремся с избыточностью. В изображениях избыточность была пространственная, в видео добавляется ещё и временная (temporal redundancy).

#### 2. Основы сжатия цифрового видео

- Видеокадры и их типы: 
  - I-frames (Key Frames): Полные кадры, не опирающиеся на другие кадры (intra, introductional).
  - P-frames: Кадры, сжатые с использованием предыдущих кадров (forward prediction).
  - B-frames: Кадры, сжатые с использованием предыдущих и последующих кадров (bidirectional prediction).
- Внутрикадровое сжатие (Intra-frame compression): Аналог сжатия статического изображения (как в JPEG).
- Межкадровое сжатие (Inter-frame compression): Использование информации из других кадров для сокращения объема данных в результирующем файле.

#### 3. Современные Видеокодеки

| Кодек      | Ключевые особенности                                                                               | Эффективность сжатия                              | Использование                                                        |
|------------|----------------------------------------------------------------------------------------------------|---------------------------------------------------|----------------------------------------------------------------------|
| H.264/AVC  | Блоковое сжатие (блоки 4x4, 8x8), Компенсация движения, Трансформационное кодирование (DCT)        | Высокая степень сжатия с хорошим качеством видео  | Видеостриминг, Blu-ray, видеокамеры, видеонаблюдение, хранение видео |
| H.265/HEVC | Большие блоки (до 64x64), Расширенная компенсация движения, на 50% эффективнее сжатия, чем у H.264 | Отлично подходит для высокого разрешения (4K, 8K) | Видеостриминг, Ultra HD телевидение, видеонаблюдение                 |
| VP9 и AV1  | Свободные от патентов, Расширенная intra-предсказание, Лучшая поддержка HDR и Wide Color Gamut     | Сжатие, сопоставимое с HEVC, открытый стандарт    | Видеостриминг (YouTube поддерживает AV1), хранение видео             |

#### 4. Принципы работы видеокодеков

- Предсказание (Prediction): 
  - Intra Prediction: Предсказание блоков внутри кадра
  - Inter Prediction: Предсказание блоков между кадрами (Motion Estimation, Motion Compensation).
- Преобразования и квантование (Transform and Quantization): 
  - DCT (Discrete Cosine Transform): Преобразование блоков в частотную область.
  - Квантование (Quantization): Сокращение точности коэффициентов DCT для сжатия.
- Энтропийное кодирование (Entropy Coding):
  - Huffman Coding: Статистическое кодирование.
  - Arithmetic Coding: Более эффективное кодирование с использованием вероятностей.

#### 5. Процесс кодирования видео

- Шаги кодирования: 
  1. Разбиение на блоки (Partitioning): Разделение кадра на блоки (например, 16x16, 8x8).
  2. Предсказание (Prediction): Intra или Inter Prediction.
  3. Вычитание предсказания (Residual Calculation): Разница между оригинальным блоком и предсказанным.
  4. Преобразования и квантование (Transform and Quantization): Преобразование и сокращение данных.
  5. Энтропийное кодирование (Entropy Coding): Сжатие оставшихся данных.
- Примеры из H.264/AVC и HEVC: 
  - H.264/AVC: Использование 4x4 и 8x8 блоков, простое квантование.
  - HEVC: Использование блоков переменного размера (до 64x64), более сложные методы предсказания.

#### 6. Процесс декодирования видео

1. Энтропийное декодирование (Entropy Decoding).
2. Обратное квантование (Inverse Quantization).
3. Обратное преобразование (Inverse Transform).
4. Добавление предсказания (Prediction Addition).
5. Восстановление кадра (Frame Reconstruction).

#### 7. Метрики качества и эффективности cжатия

- MOS (Mean Opinion Score), DSPI (Double Stimulus Perception Indicator) -- субъективные метрики качества видео
- PSNR (Peak Signal-to-Noise Ratio): Измерение ошибки между оригинальным и сжатым видео.
- SSIM (Structural Similarity Index): Измерение структурного сходства между кадрами.
- VMAF (Video Multimethod Assessment Fusion): Современный метод оценки качества видео, использующий машинное обучение.
- VQM (Video Quality Metric) является гибридной метрикой, сочетающей субъективные и объективные измерения для оценки качества видео
- RDO (Rate-Distortion Optimization): Баланс между битрейтом и качеством видео.

#### 8. Будущее видеокодеков

- Кодеки AV1, VVC (H.266) уже существуют и ограниченно используются. Но их поддержка в сервисах и аппаратуре пока ограничена, она будет развиваться.
- Машинное обучение в сжатии видео: Использование нейронных сетей для улучшения качества сжатия.
- Потребности 8K и видео с высокой частотой кадров (HFR): Требования к более эффективному сжатию.

### Сравнение внутрикадрового предсказания (Intra Prediction)

| Кодек | Размеры блоков | Режимы предсказания |
|-------|----------------|---------------------|
| H.264 | 4x4, 8x8       | 9 режимов           |
| H.265 | до 32x32       | 35 режимов          |
| VP9   | до 128x128     | 10 режимов          |
| AV1   | до 128x128     | 82 режима           |

---

### Сравнение межкадрового предсказания (Inter Prediction)

| Кодек | Точность векторов движения | Поддержка аффинного движения |
|-------|----------------------------|------------------------------|
| H.264 | 1/4 пикселя                | Нет                          |
| H.265 | 1/4 пикселя                | Да                           |
| VP9   | 1/8 пикселя                | Да                           |
| AV1   | 1/8 пикселя                | Да                           |

---

### Сравнение преобразований (Transform)

| Кодек | Размеры блоков для преобразования | Типы преобразований |
|-------|-----------------------------------|---------------------|
| H.264 | 4x4, 8x8                          | DCT                 |
| H.265 | до 32x32                          | DCT, DST            |
| VP9   | до 128x128                        | DCT, DST            |
| AV1   | до 128x128                        | DCT, DST и другие   |

---

### Сравнение квантования (Quantization)

| Кодек | Тип квантования |
|-------|-----------------|
| H.264 | Адаптивное      |
| H.265 | Более гибкое    |
| VP9   | Продвинутое     |
| AV1   | Неравномерное   |

---

### Сравнение энтропийного кодирования (Entropy Coding)

| Кодек | Метод энтропийного кодирования         |
|-------|----------------------------------------|
| H.264 | CABAC/CAVLC                            |
| H.265 | Улучшенный CABAC                       |
| VP9   | Контекстное моделирование              |
| AV1   | Продвинутое арифметическое кодирование |


### Сравнение алгоритмов CABAC и CAVLC

| Критерий                 | CABAC (Context-Adaptive Binary Arithmetic Coding)                                                                                                             | CAVLC (Context-Adaptive Variable Length Coding)                                                                                        |
|--------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|
| Сжатие                   | Высокая эффективность сжатия благодаря арифметическому кодированию, которое позволяет представить символы с количеством бит, близким к их энтропии.           | Низкая эффективность сжатия по сравнению с CABAC, так как метод переменной длины кодирования не приближает энтропию так же эффективно. |
| Вычислительная сложность | Высокая, из-за сложных операций арифметического кодирования.                                                                                                  | Низкая, так как метод VLC (не путайте с одноименной программой!) проще в реализации и быстрее для декодирования.                       |
| Сложность реализации     | Высокая, требует модели вероятностей и адаптивных контекстов.                                                                                                 | Низкая, проще реализовать из-за использования переменной длины кодирования.                                                            |
| Стойкость к ошибкам      | Хорошая, но может быть чувствительна к ошибкам, если не защищена должным образом.                                                                             | Стойкость к ошибкам может быть лучше для некоторых реализаций, но в целом сравнима с CABAC.                                            |
| Использование            | Широко используется в стандартах видеокодирования H.264/AVC и H.265/HEVC для кодирования синтаксических элементов, таких как остатки, векторы движения и т.д. | Используется в H.264/AVC для некоторых синтаксических элементов, где предпочтение отдается низкой сложности.                           |

🟦 Типы видеокадров
Тип видеокадра
Описание
Использование
Размер
I-кадры 
(Intra-кадры)
Содержат полную информацию о кадре, не требуют других кадров для декодирования.
Используются как ключевые кадры для поиска и случайного доступа, а также как база для предсказания P- и B-кадров.
Большие по размеру из-за полной информации, но важны для резервного копирования и восстановления.
P-кадры
(Predictive-кадры)
Содержат разницу с предыдущим кадром ( I или P), требуют декодирования предыдущего кадра.
Эффективны в сжатии, так как хранят только изменения относительно предыдущего кадра.
Меньше по размеру, чем I-кадры, и могут служить базой для будущих P- и B-кадров.
B-кадры 
(Bi-predictive-кадры)
Используют как предыдущие, так и будущие кадры для предсказания, требуют декодирования нескольких кадров.
Предоставляют высокую эффективность сжатия, но более сложны в декодировании и могут увеличивать задержку.
Наиболее эффективны в сжатии, но требуют более сложного декодирования.
Пирамидальные кадры
Вероятно, связаны с иерархической кодировкой, где кадры организованы в иерархическую структуру для разных уровней качества или разрешения.
Используются в масштабируемой кодировке видео, позволяя адаптировать видео к различным условиям сети или устройств.
Размер зависит от их роли в иерархической структуре.
Структура Group of Pictures (GOP): Последовательность кадров, включая один I-кадр и несколько P- и B-кадров, влияет на эффективность сжатия, качество и способ воспроизведения.

Порядок декодирования vs. порядок представления: Декодирование может происходить в другом порядке, чем представление, для оптимизации сжатия и управления зависимостями.

Надежность при ошибках: Более частое использование I-кадров может уменьшить влияние ошибок, но увечит объем файла или битрейт потока.

Кодеки и стандарты: Различные кодеки (H.264/AVC, H.265/HEVC, AV1) обрабатывают кадры по-разному, с возможными отличиями в поддержке и использовании B-кадров. B-кадры не используются в "слабом" (baseline) профиле H.264.

Применение в потоковой передаче и редактировании: Выбор типа кадра влияет на задержку, качество и требования к устройству.

Преобразования DCT (Discrete Cosine Transform, дискретное косинусное преобразование) и DST (Discrete Sine Transform, дискретное синусное преобразование) — это математические методы, используемые в обработке изображений и видео для преобразования данных из пространственной области (пиксели) в частотную область (коэффициенты). Они играют ключевую роль в сжатии видео, так как позволяют эффективно удалять избыточность данных и концентрировать энергию сигнала в небольшом количестве коэффициентов.

---

### 1. DCT (Дискретное косинусное преобразование)

DCT — это ортогональное преобразование, которое преобразует сигнал (например, блок пикселей) в сумму косинусных функций с разными частотами. В видеокодеках DCT используется для преобразования остаточных данных (разницы между предсказанным и реальным кадром) в частотную область.

- Типы DCT: 
  - DCT-II: Наиболее распространённый тип, используемый в видеокодеках (например, H.264, H.265). Он эффективно концентрирует энергию в низкочастотных коэффициентах.
  - DCT-VIII: Используется в современных кодеках, таких как VVC (Versatile Video Coding), для улучшения сжатия.
  - DCT-IV: Применяется в некоторых специализированных задачах, например, в обработке звука.
- Применение: 
  - В H.264 и H.265 DCT применяется к блокам 4x4, 8x8, 16x16 и 32x32.
  - В VVC добавлены более крупные блоки (до 64x64) и комбинации с другими преобразованиями, такими как DST.

---

### 2. DST (Дискретное синусное преобразование)

DST — это преобразование, аналогичное DCT, но использующее синусные функции вместо косинусных. Оно особенно полезно для обработки данных с определёнными граничными условиями (например, нулевыми значениями на границах).

- Типы DST: 
  - DST-VII: Широко используется в современных кодеках (например, VVC, он же H.266) для обработки остаточных данных внутрикадрового предсказания.
  - DST-I: Применяется в некоторых задачах обработки сигналов.
  - DST-IV: Используется в комбинации с другими преобразованиями для улучшения сжатия.
- Применение: 
  - В H.265/HEVC DST-VII применяется для блоков 4x4 в режиме внутрикадрового предсказания.
  - В VVC DST-VII используется в сочетании с DCT для улучшения сжатия в различных режимах предсказания.

---

### 3. Другие типы преобразований

Помимо DCT и DST, в видеокодеках используются и другие преобразования:

- Hadamard Transform (Преобразование Адамара): 
  - Быстрое ортогональное преобразование, используемое для обработки DC-коэффициентов (постоянной составляющей) в H.264 и H.265.
  - Применяется для упрощения вычислений и уменьшения сложности.
- Multiple Transform Selection (MTS): 
  - В VVC используется набор преобразований (DCT-II, DST-VII, DCT-VIII), которые выбираются в зависимости от типа данных и режима предсказания.
  - Это позволяет адаптировать преобразование к характеристикам данных, улучшая сжатие.
- Wavelet Transform (Вейвлет-преобразование): 
  - Используется в некоторых специализированных кодеках (например, JPEG 2000) для обработки изображений с высокой детализацией.

---

### 4. Пример использования в видеокодеках

- H.264/AVC: 
  - Использует целочисленное DCT (Integer DCT) для блоков 4x4 и 8x8.
  - Hadamard Transform применяется для обработки DC-коэффициентов.
- H.265/HEVC: 
  - Расширяет использование DCT до блоков 16x16 и 32x32.
  - Вводит DST-VII для обработки остаточных данных внутрикадрового предсказания.
- VVC: 
  - Использует комбинацию DCT-II, DST-VII и DCT-VIII для улучшения сжатия.
  - Добавляет поддержку блоков до 64x64.

---

### 5. Преимущества преобразований

- Эффективное сжатие: DCT и DST концентрируют энергию сигнала в небольшом количестве коэффициентов, что позволяет отбрасывать высокочастотные компоненты с минимальной потерей качества.
- Адаптивность: Современные кодеки, такие как VVC, используют несколько типов преобразований, чтобы лучше адаптироваться к характеристикам данных.
- Упрощение вычислений: Целочисленные версии DCT и DST уменьшают сложность вычислений, что важно для реального времени.

Квантование в контексте алгоритмов кодирования — это процесс уменьшения точности представления данных с целью сокращения их объема. Это достигается за счет округления или отбрасывания менее значимых частей информации, что приводит к потере некоторых деталей, но позволяет значительно уменьшить размер данных. Квантование является ключевым этапом в сжатии с потерями (lossy compression), которое используется  для изображений (например, JPEG) и видеокодеках (H.264, H.265 (HEVC), AV1, VP9 и т.д.)

### Квантование в JPEG

В алгоритме JPEG квантование применяется после преобразования изображения в частотную область с помощью дискретного косинусного преобразования (DCT). Каждый блок изображения (обычно 8x8 пикселей) преобразуется в набор коэффициентов, которые представляют различные частотные компоненты изображения. Эти коэффициенты затем квантуются с использованием матрицы квантования.

- Матрица квантования: Задает шаг квантования для каждого коэффициента. Высокочастотные коэффициенты (отвечающие за мелкие детали) обычно квантуются сильнее, чем низкочастотные (отвечающие за общую структуру изображения).
- Потери: После квантования высокочастотные коэффициенты часто становятся нулевыми или близкими к нулю, что позволяет эффективно сжимать данные с помощью энтропийного кодирования (например, Хаффмана или арифметического кодирования). Однако это приводит к потере мелких деталей и появлению артефактов, таких как "блочность".

### Квантование в видеокодеках

В видеокодеках квантование применяется к коэффициентам преобразования (например, DCT или более сложным преобразованиям, таким как преобразование Караунена-Лоэва в AV1) после предсказания и компенсации движения. Основная цель — уменьшить объем данных, сохраняя при этом приемлемое качество видео.

1. H.264 (AVC):
   - Использует целочисленное квантование для коэффициентов DCT.
   - Шаг квантования (QP, Quantization Parameter) определяет степень сжатия. Чем больше QP, тем сильнее квантование и выше степень сжатия, но тем больше потери качества.
   - Квантование применяется как к яркостным, так и к цветовым компонентам.
2. H.265 (HEVC):
   - Использует более сложные схемы квантования, включая адаптивное квантование в зависимости от содержимого блока.
   - Поддерживает более широкий диапазон QP, что позволяет лучше контролировать компромисс между качеством и степенью сжатия.
   - В HEVC также применяется квантование для коэффициентов преобразования, но с улучшенной эффективностью благодаря более крупным блокам (до 32x32).
3. VP9:
   - Использует адаптивное квантование с учетом сложности сцены и локальных особенностей изображения.
   - Поддерживает несколько  матриц квантования для разных типов блоков.
   - Квантование применяется после преобразования, аналогичного DCT, но с дополнительными оптимизациями для повышения эффективности сжатия.
4. AV1:
   - Использует гибкие схемы квантования, включая адаптивное квантование и множественные матрицы квантования.
   - Поддерживает не только стандартное квантование, но и более сложные методы, такие как квантование с учетом перцептивных особенностей человеческого зрения.
   - AV1 также применяет квантование к коэффициентам после преобразования, но с учетом более сложных структур блоков и предсказаний.

### Общие принципы квантования в видеокодеках:

- Адаптивность: Современные кодеки используют адаптивное квантование, чтобы учитывать сложность сцены, движение и другие факторы.
- Перцептивное квантование: Некоторые кодеки (например, AV1) учитывают особенности человеческого зрения, квантуя менее заметные детали сильнее.
- Компенсация потерь: После квантования применяются методы постобработки (например, деблокирующие фильтры), чтобы уменьшить видимые артефакты.

Энтропийное кодирование — это метод сжатия данных, который используется для уменьшения количества битов, необходимых для представления информации. В контексте видеокодеков этот метод применяется для сокращения объема видеопотока без значительного ухудшения качества видео. Давайте разберем подробнее, как работает энтропийное кодирование и какие алгоритмы используются в современных видеокодеках.

### Основные принципы

Основная идея энтропийного кодирования заключается в том, чтобы использовать статистические свойства данных для их эффективного сжатия. Это достигается за счет того, что символы (или группы символов), которые встречаются чаще, кодируются меньшим количеством бит, чем те, которые встречаются реже. Таким образом, среднее количество бит на символ уменьшается.

### Алгоритмы энтропийного кодирования

Существует несколько популярных методов энтропийного кодирования:

#### 1. Кодирование Хаффмана (Huffman Coding)

Кодирование Хаффмана является одним из самых простых и широко используемых методов энтропийного кодирования. Оно основано на построении дерева Хаффмана, где каждый лист соответствует одному символу, а путь от корня к этому листу представляет собой код этого символа. Символы с большей вероятностью появления получают более короткие коды, а менее вероятные — длинные.

Пример работы кодера Хаффмана:

- Пусть у нас есть последовательность символов: AABBCCD.
- Вероятность каждого символа: A = 0.25, B = 0.25, C = 0.375, D = 0.125.
- Построим дерево Хаффмана и присвоим каждому символу соответствующий код: 
  - A → 00
  - B → 01
  - C → 10
  - D → 11

Таким образом, исходная последовательность будет закодирована следующим образом: 0001001010111100, что займет меньше места, чем исходный поток.

#### 2. Арифметическое кодирование (Arithmetic Coding)

Арифметическое кодирование позволяет достичь еще большего сжатия по сравнению с кодированием Хаффмана. Вместо того чтобы присваивать фиксированные коды отдельным символам, арифметический кодер использует интервалы чисел для представления всей последовательности символов. Этот интервал постепенно сужается по мере обработки новых символов.

Преимущества арифметического кодирования перед кодированием Хаффмана заключаются в следующем:

- Возможность использования дробных значений вероятности для символов.
- Более высокая степень сжатия при больших объемах данных.

Однако арифметическое кодирование сложнее реализовать и оно требует больше вычислительных ресурсов.

#### 3. Контекстное адаптивное бинарное арифметическое кодирование (CABAC)

Контекстное адаптивное бинарное арифметическое кодирование (Context-based Adaptive Binary Arithmetic Coding) — это усовершенствованный метод энтропийного кодирования, используемый в стандартах H.264/AVC и H.265/HEVC. Он сочетает в себе преимущества арифметического кодирования с учетом контекста предыдущих символов для улучшения предсказания вероятности текущего символа.

В CABAC вероятность появления символа определяется на основе его контекста, то есть соседних символов. Это позволяет более точно оценивать вероятности и достигать лучшего сжатия.

### Применение в видеокодеках

Современные видеокодеки, такие как H.264/AVC, H.265/HEVC и AV1, используют различные методы энтропийного кодирования для достижения высокой степени сжатия видеопотоков. Например:

- H.264/AVC использует CAVLC (Context-Adaptive Variable-Length Coding) и CABAC.
- H.265/HEVC также применяет CABAC, но с улучшенными алгоритмами контекстной адаптации.
- AV1 использует энтропийный кодер, основанный на арифметическом кодировании с использованием контекстов.

Эти методы позволяют значительно уменьшить размер видеофайлов без существенной потери качества, что особенно важно для передачи видео через интернет и хранения на устройствах с ограниченным объемом памяти.

Аффинное движение  (преобразование) – это понятие, связанное с изучением перемещений и трансформаций в геометрии, которое описывает такие движения, при которых сохраняются параллельные линии и отношения между расстояниями на плоскости или в пространстве.

## Матричное уравнение аффинного преобразования для двумерных координат

![image.png](.attachments.69979/image.png)

Разбор уравнения

(𝑥 𝑦): вектор исходных координат точки.

(𝑥′ 𝑦′): вектор преобразованных координат после применения аффинного преобразования.

(𝑎 𝑏 𝑐 𝑑): матрица линейного преобразования, где:

a: масштабирование по оси x.

b: наклон или искажение в направлении оси y.

c: наклон или искажение в направлении оси x.

d: масштабирование по оси y.

(𝑒 𝑓): вектор сдвига, который указывает, насколько точки должны быть смещены после линейного преобразования.

## Основные характеристики аффинного движения

Аффинное движение включает в себя такие трансформации, как вращения, сдвиги, масштабирование и наклоны. Эти трансформации позволяют сохранять линейные свойства объектов, такие как прямолинейность, коллинеарность и пропорциональность.

## Примеры применения аффинного движения

Аффинное движение используется в различных областях, включая компьютерную графику, робототехнику и анализ движений. Например, в компьютерной графике аффинные трансформации применяются для изменения положения, масштаба или ориентации объектов в трехмерном пространстве.

## Связь с другими геометрическими понятиями

Аффинное движение связано с другими понятиями в геометрии, такими как евклидова и проективная геометрия. Оно служит основой для изучения более сложных движений и трансформаций, таких как оболочковая или логарифмическая деформация.

## Исследования и открытия в области аффинного движения

Существуют разные исследования, направленные на понимание аффинного движения, например, анализ аффинной геометрии в движениях человеческой руки. Такие исследования помогают в разработке алгоритмов и моделей для более точного описания движений в различных приложениях.

Intra Prediction (внутрикадровое предсказание) — это метод сжатия видео, на котором были построены кодеки DV, MJPEG, не имевшие межкадрового сжатия. Внутрикадровое предсказание используется и во всех современных видеокодеках (например, H.264, H.265, VP9, AV1), который позволяет уменьшить избыточность информации внутри одного кадра. В отличие от Inter Prediction (межкадрового предсказания), которое использует информацию из других кадров, Intra Prediction работает только с данными внутри текущего кадра.

---

### Как работает Intra Prediction?

1. Основная идея:
   - Внутри одного кадра часто присутствуют области с однородными цветами, текстурами или градиентами (например, небо, стены, фон).
   - Вместо того чтобы кодировать каждый пиксель независимо, кодек предсказывает значения пикселей в блоке на основе соседних пикселей.
2. Разделение на блоки:
   - Кадр делится на блоки (например, 4x4, 8x8, 16x16 или даже 32x32 пикселей).
   - Для каждого блока применяется внутрикадровое предсказание.
3. Режимы предсказания:
   - В зависимости от содержимого блока, кодек выбирает один из нескольких режимов предсказания. Эти режимы определяют, как будут предсказаны значения пикселей в блоке на основе соседних пикселей.
   - Например, если блок находится рядом с горизонтальной границей, кодек может использовать горизонтальный режим предсказания, где значения пикселей копируются из верхних соседей.
4. Примеры режимов предсказания:
   - DC-режим: Предсказывает среднее значение соседних пикселей.
   - Горизонтальный режим: Копирует значения из верхних соседей.
   - Вертикальный режим: Копирует значения из левых соседей.
   - Диагональные режимы: Используют диагональные направления для предсказания.
   - Плоскостной режим: Предсказывает значения с использованием линейного градиента.
5. Кодирование остаточной информации:
   - После предсказания кодек вычисляет разницу между реальными значениями пикселей и предсказанными (это называется остаточной информацией).
   - Остаточная информация кодируется и передается вместе с информацией о выбранном режиме предсказания.

---

### Пример работы Intra Prediction

Представьте, что у вас есть блок 4x4 пикселей:

```
A B C D
E F G H
I J K L
M N O P
```

- Если кодек выбирает горизонтальный режим, то значения пикселей в блоке будут предсказаны на основе верхних соседей (A, B, C, D).
- Если выбирается вертикальный режим, то значения будут предсказаны на основе левых соседей (A, E, I, M).
- После предсказания вычисляется разница между реальными значениями и предсказанными, и эта разница кодируется.

---

### Преимущества Intra Prediction

- Эффективное сжатие: Уменьшает избыточность внутри кадра, что особенно полезно для статических сцен или областей с однородными текстурами.
- Независимость от других кадров: Поскольку Intra Prediction работает только внутри одного кадра, она используется в I-кадрах (ключевых кадрах), которые не зависят от других кадров. Это важно для восстановления видео при потере данных или для случайного доступа к кадрам.

---

### Пример в кодеках

- H.264: Поддерживает 9 режимов предсказания для блоков 4x4 и 4 режима для блоков 16x16.
- H.265 (HEVC): Увеличивает количество режимов до 35 для блоков разных размеров (до 32x32).
- AV1: Включает более 80 режимов предсказания, включая сложные методы, такие как рекурсивное предсказание и фильтрация границ.

Inter Prediction (межкадровое предсказание) — это один из ключевых методов сжатия видео в современных видеокодеках (например, H.264, H.265 (HEVC), VP9 и AV1. Его цель — уменьшить избыточность информации между последовательными кадрами видео, используя временную корреляцию (то есть сходство между кадрами).

### Как работает Inter Prediction?

1. Основная идея:
   - В видео последовательные кадры часто очень похожи друг на друга (например, фон или медленно движущиеся объекты).
   - Вместо того чтобы кодировать каждый кадр полностью, кодеки кодируют только разницу между текущим кадром и предыдущими или последующими кадрами.
2. Движение и векторы движения:
   - Если объект в видео перемещается, кодек вычисляет его движение и создает вектор движения (Motion Vector), который показывает, куда сместился объект относительно предыдущего кадра.
   - Вектор движения позволяет предсказать, где объект будет находиться в текущем кадре, основываясь на его положении в предыдущих или последующих кадрах.
3. Типы кадров:
   - I-кадры (Intra-coded frames): Полностью самостоятельные кадры, которые кодируются без ссылок на другие кадры.
   - P-кадры (Predicted frames): Кодируются с использованием предсказания на основе предыдущих кадров (I- или P-кадров).
   - B-кадры (Bi-directional frames): Кодируются с использованием предсказания как из предыдущих, так и из последующих кадров.
4. Процесс предсказания:
   - Кодек делит кадр на блоки (например, 16x16 пикселей).
   - Для каждого блока ищется наиболее похожий блок в предыдущих или последующих кадрах (это называется поиск движения).
   - Разница между текущим блоком и предсказанным блоком (остаточная информация) кодируется и передается.
5. Точность предсказания:
   - Современные кодеки поддерживают высокую точность предсказания, например, до 1/8 пикселя (восьмая пиксельная точность). Это позволяет более точно предсказывать движение и уменьшать артефакты.
6. Аффинное движение:
   - В более продвинутых кодеках (например, H.265 и AV1) используется аффинное предсказание, которое учитывает не только линейное смещение, но и поворот, масштабирование и другие сложные движения.

---

### Пример работы Inter Prediction

Представьте, что у вас есть видео с движущейся машиной:

- В первом кадре машина находится в позиции (x, y).
- Во втором кадре машина сместилась в позицию (x+10, y+5).
- Вместо того чтобы кодировать второй кадр полностью, кодек: 
  1. Находит вектор движения (10, 5).
  2. Предсказывает положение машины во втором кадре на основе первого кадра.
  3. Кодирует только разницу между предсказанным и реальным положением машины.

---

### Преимущества Inter Prediction

- Высокая степень сжатия: За счет использования временной избыточности достигается значительное уменьшение объема данных.
- Улучшение качества: Современные методы, такие как аффинное предсказание и высокая точность векторов движения, позволяют минимизировать артефакты.

---

### Пример в кодеках

- H.264: Использует межкадровое предсказание с точностью до 1/4 пикселя.
- H.265 (HEVC): Добавляет поддержку аффинного движения и улучшает точность.
- AV1: Включает продвинутые методы, такие как глобальное движение и более сложные режимы предсказания.

Теоремы Котельникова, Найквиста и Шеннона относятся к области цифровой обработки сигналов и теории информации. Они играют ключевую роль в понимании того, как аналоговые сигналы могут быть представлены в цифровом виде без потери информации, а также как эффективно передавать данные через ограниченные каналы связи.

### Теорема Котельникова

Теорема Котельникова, также известная как теорема отсчетов, утверждает следующее:

::: info
Любая функция f(t), спектр которой ограничен частотой F, может быть полностью восстановлена по её дискретным значениям, взятым с интервалом  
1 / 2F:

:::

![image (2).png](.attachments.70358/image%20%282%29.png)

Другими словами, для точного восстановления непрерывного сигнала достаточно взять его значения через равные промежутки времени, но частота выборок должна быть как минимум вдвое больше максимальной частоты спектра этого сигнала. Это означает, что сигнал с ограниченной полосой частот может быть представлен конечным числом значений в единицу времени -- это утверждение обосновывает возможность оцифровки аналоговых сигналов.

#### Применение в кодировании и сжатии данных

Теорема Котельникова лежит в основе процесса оцифровки аналоговых сигналов (изображения, звук, видео). Например, когда мы записываем аудиосигнал, нам необходимо преобразовать его в последовательность чисел (дискретных значений). Частота дискретизации выбирается исходя из критерия Котельникова: чтобы избежать потерь информации, частота дискретизации должна быть не менее чем удвоенная максимальная частота исходного сигнала.

В случае с цифровым звуком стандартная частота дискретизации составляет 44,1 кГц (для CD), что позволяет точно восстанавливать звуки до 22,05 кГц, что превышает возможности человеческого слуха (20 кГц).

### Критерий Найквиста

Критерий Найквиста является частным случаем теоремы Котельникова и формулируется следующим образом:

::: info
Для корректной передачи сигнала с верхней граничной частотой F необходимо, чтобы частота дискретизации была не меньше 2F.

:::

Этот критерий важен для понимания минимально допустимой частоты дискретизации, которая гарантирует отсутствие искажений при восстановлении сигнала.

#### Связь с теоремой Котельникова

Как уже было сказано выше, критерий Найквиста представляет собой упрощенную версию теоремы Котельникова. В то время как теорема Котельникова описывает процесс восстановления сигнала по его дискретным значениям, критерий Найквиста акцентирует внимание на том, какая минимальная частота дискретизации необходима для предотвращения искажений.

### Теорема Шеннона-Хартли

Теорема Шеннона-Хартли относится к передаче информации по каналам связи и определяет максимальную скорость передачи данных через канал с заданными характеристиками:

![image.png](.attachments.70358/image.png)

где:

- B обозначает ширину полосы пропускания.
- S и N представляют мощность сигнала и шум соответственно.
- S/N — это результат деления мощности сигнала на мощность шума.
- 1 + S/N — сумма единицы и результата предыдущего деления.
- Log2(1 + S/N) — логарифм по основанию 2 от суммы.
- C — итоговая пропускная способность канала.

Эта формула показывает, что пропускная способность канала зависит от ширины полосы пропускания и отношения сигнал/шум. Чем шире полоса и чем лучше соотношение сигнал/шум, тем больше информации можно передать за единицу времени.

#### Применение в кодировании и сжатии данных

Теорема Шеннона используется для оценки предельной скорости передачи данных в различных системах связи, включая интернет-соединения, мобильные сети и спутниковую связь. Она помогает понять, сколько информации можно передать через конкретный канал связи, учитывая ограничения по полосе пропускания и уровню шума.

### Сжатие данных

При кодировании и сжатии данных используются различные методы, основанные на принципах, заложенных в указанных теоремах. Вот несколько примеров:

1. Кодирование видео: При кодировании видео применяются алгоритмы компрессии, такие как MPEG, H.264 и другие. Эти алгоритмы используют дискретизацию пространственных и временных характеристик видео, основываясь на теореме Котельникова. Кроме того, они учитывают человеческое восприятие визуальной информации, сжимая данные таким образом, чтобы минимизировать видимые артефакты.
2. Кодирование аудио: Аудиофайлы, такие как MP3, AAC и другие, также основаны на принципах дискретизации и компрессии. Алгоритмы сжатия аудио учитывают особенности восприятия звуков человеком, удаляя избыточную информацию и сохраняя только те компоненты сигнала, которые важны для качественного воспроизведения.
3. Сжатие изображений: Форматы JPEG, PNG и другие используют различные подходы к сжатию изображений, включая дискретизацию и удаление избыточной информации. Например, алгоритм JPEG основан на дискретном косинусном преобразовании, которое позволяет уменьшить объем данных, сохранив при этом качество изображения.

### Основные выводы при кодировании видео и звука

1. Частота дискретизации: Для точного представления аналогового сигнала в цифровом виде необходимо выбирать частоту дискретизации, удовлетворяющую критерию Найквиста-Котельникова. Это особенно важно при записи и обработке аудио и видео.
2. Ширина полосы пропускания: Пропускная способность канала связи ограничивает количество информации, которую можно передать за единицу времени. Поэтому при проектировании систем связи следует учитывать теорему Шеннона-Хартли.
3. Компрессия данных: Современные алгоритмы сжатия видео и аудио используют различные методы удаления избыточной информации, сохраняя при этом приемлемое качество. Важно понимать, какие аспекты сигнала являются критическими для восприятия человеком, чтобы обеспечить оптимальное соотношение качества и размера файла.
4. Оптимизация каналов связи: При разработке коммуникационных систем необходимо учитывать ограничения по ширине полосы пропускания и уровню шума, чтобы максимально эффективно использовать доступные ресурсы.

Параметр
Описание
Определение
Rate-Distortion Optimization (RDO) — метод оптимизации, используемый в сжатии видео для нахождения оптимального компромисса между битрейтом и искажениями.
Цель
Достижение наилучшего качества видео при заданном bitrate или наименьшего bitrate при заданном уровне искажений.
Формула
J = D + л * R , где J  — целевая функция, D — искажения, R — bitrate, л — множитель Лагранжа, регулирующий баланс.
Применение в видеокодеках
Используется для выбора оптимальных параметров кодирования, таких как режимы предсказания, уровни квантования и другие.
Преимущества
Улучшает эффективность сжатия, обеспечивая качество при меньшем битрейте.
Недостатки
Высокая вычислительная сложность, увеличивающая время кодирования.
Интерпретация значений
Чем ниже значение J, тем лучше компромисс между битрейтом и качеством.
Сравнение с другими методами
Предоставляет лучший контроль над битрейтом и качеством по сравнению с неоптимизированными методами.
Практическое использование
Широко применяется в современных видеокодеках, таких как H.264/AVC, H.265/HEVC, для потокового вещания, хранения и передачи видео.

### Классификация метрик качества видеокомпрессии

| Категория            | Метрика                                     | Назначение                                                                                                                             | Ограничения                                                                            |
|----------------------|---------------------------------------------|----------------------------------------------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------------|
| Субъективные метрики |                                             |                                                                                                                                        |                                                                                        |
|                      | MOS (Mean Opinion Score)                    | Оценка качества видео с помощью человеческого восприятия, путем опроса участников.                                                     | Субъективна, зависит от восприятия различных людей, затратна по времени.               |
|                      | DSPI (Double Stimulus Perception Indicator) | Сравнение качества двух видеофрагментов с целью определения, какой из них лучше.                                                       | Субъективна, требует участия людей, может быть затратной по времени.                   |
| Объективные метрики  |                                             |                                                                                                                                        |                                                                                        |
|                      | PSNR (Peak Signal-to-Noise Ratio)           | Измеряет разницу между оригинальным и сжатым видео в терминах сигнал/шум.                                                              | Не всегда коррелирует с субъективным восприятием качества видео.                       |
|                      | SSIM (Structural Similarity Index)          | Измеряет структурное сходство между оригинальным и сжатым видео.                                                                       | Более сложная для вычисления, чем PSNR, и может не учитывать некоторые виды искажений. |
|                      | VMAF (Video Multimethod Assessment Fusion)  | Комбинированная метрика, использующая несколько объективных методов для оценки качества видео, с корреляцией с субъективными оценками. | Требует значительных вычислительных ресурсов и обучение на большом количестве данных.  |
| Гибридные метрики    |                                             |                                                                                                                                        |                                                                                        |
|                      | VQM (Video Quality Metric)                  | Гибридная метрика, сочетающая объективные измерения с некоторыми субъективными факторами.                                              | Более сложна в реализации, чем объективные метрики, и может требовать настройки.       |

1. MOS (Mean Opinion Score):
   - Назначение: MOS является субъективной метрикой, которая оценивает качество видео на основе средней оценки, данной группой наблюдателей. Часто используется в виде шкалы от 1 (очень плохое качество) до 5 (превосходное качество).
   - Ограничения: Результаты могут сильно варьироваться в зависимости от участников опроса, и этот метод может быть дорогостоящим и затратным по времени.
2. DSPI (Double Stimulus Perception Indicator):
   - Назначение: DSPI также является субъективной метрикой, где участники сравнивают два видеофрагмента и выбирают тот, который кажется им лучше.
   - Ограничения: Как и MOS, DSPI зависит от субъективного восприятия участников и может быть затратным по времени.
3. PSNR (Peak Signal-to-Noise Ratio):
   - Назначение: PSNR является объективной метрикой, которая измеряет разницу между оригинальным и сжатым видео в терминах сигнал/шум. Чем выше значение PSNR, тем лучше качество видео.
   - Ограничения: PSNR не всегда коррелирует с субъективным восприятием качества видео, особенно при наличии структурных искажений.
4. SSIM (Structural Similarity Index):
   - Назначение: SSIM является объективной метрикой, которая измеряет структурное сходство между оригинальным и сжатым видео. Она учитывает такие факторы, как luminance, contrast, и structure.
   - Ограничения: SSIM может быть более сложной для вычисления, чем PSNR, и может не учитывать некоторые виды искажений, такие как блочность.
5. VMAF (Video Multimethod Assessment Fusion):
   - Назначение: VMAF является гибридной метрикой, которая комбинирует несколько объективных методов оценки качества видео и корректирует их с помощью машинного обучения для достижения высокой корреляции с субъективными оценками.
   - Ограничения: VMAF требует значительных вычислительных ресурсов и большого количества данных для обучения, что может быть проблемой для некоторых применений.
6. VQM (Video Quality Metric):
   - Назначение: VQM является гибридной метрикой, которая сочетает в себе объективные измерения с некоторыми субъективными факторами, такими как контекст и содержание видео.
   - Ограничения: VQM может быть более сложной в реализации, чем объективные метрики, и может требовать настройки для различных типов видео.

Выбор метрики качества видеокомпрессии зависит от конкретных требований вашего проекта. Субъективные метрики, такие как MOS и DSPI, дают прямое представление о том, как воспринимается качество видео людьми, но они могут быть затратными и нестабильными. Объективные метрики, такие как PSNR и SSIM, обеспечивают быстрые и точные оценки, но могут не полностью соответствовать субъективным оценкам. Гибридные метрики, такие как VMAF и VQM, предлагают компромисс между объективностью и субъективностью, но могут быть более сложными в реализации.

Раздел
Описание
Определение
Mean Opinion Score (MOS) - это субъективный показатель, используемый для оценки качества видеосигналов или аудиосигналов, представляющий среднюю оценку, данную группой людей.
Масштаб и Оценка
Оценивается по пятибалльной шкале: 
1 - Непригодно, 
2 - Плохо, 
3 - Средне, 
4 - Хорошо, 
5 - Отлично.
Приложения
Используется в телекоммуникациях для оценки качества голоса в телефонных разговорах или VoIP, а также для оценки качества сжатого видеоконтент.
Ограничения
Результаты могут варьироваться из-за индивидуальных предпочтений, опыта и факторов внешнего окружения. Требует времени и ресурсов.
Сравнение с объективными метриками
PSNR (Peak Signal-to-Noise Ratio) и SSIM (Structural Similarity Index) - это объективные метрики, которые можно вычислить автоматически, но они не всегда коррелируют с восприятием человека.
Использование и стандарты
Оценки MOS часто следуют стандартам или протоколам. Например, рекомендации ITU-T для субъективной оценки качества.
Влияние факторов сжатия
На MOS могут влиять артефакты сжатия, частота кадров, разрешение и битрейт.
Изменения и улучшения
Возможные вариации включают взвешенный MOS, где некоторые аспекты видео получают больше внимания при оценке.

Параметр
Описание
Название
DSPI (Double Stimulus Perception Indicator)
Тип
Субъективный показатель качества видео
Определение
Метод оценки качества видео, в котором участники сравнивают две видеозаписи и выбирают более предпочтительную
Использование
Используется в видеообработке, телекоммуникациях и потоковой передаче для оценки качества сжатого видео
Метод оценивания
Участники смотрят две видеозаписи и выбирают ту, которая кажется им лучше
Преимущества
Снижает вариативность субъективных мнений, так как участники сравнивают две опции, а не оценивают одну по шкале
Ограничения
Может быть более затратным по времени, особенно при большом количестве пар для сравнения; возможное влияние порядка представления примеров.
Сравнение с MOS
DSPI может быть более точным, так как основан на сравнении, в то время как MOS использует абсолютную оценку
Стандарты и протоколы
Существуют рекомендации по количеству участников, продолжительности сравнения и типам видеоконтента.
Приложения
А/B-тестирование различных алгоритмов сжатия видео, оценка влияния задержки сети на качество видео.
Связь с другими метриками
Исследования показывают корреляцию с MOS, но могут отличаться от объективных метрик, таких как PSNR или SSIM.
Развитие и модификации
Возможно наличие вариантов или усовершенствований DSPI для устранения ограничений.

Параметр
Описание
Определение
PSNR (Peak Signal-to-Noise Ratio) — это метрика, используемая для оценки качества восстановления сигнала, часто применяемая в сжатии изображений и видео.
Формула
PSNR = 20  log10(MAX_I) - 10  log10(MSE), 
где MAX_I — максимальное возможное значение пикселя (например, 255 для 8-битных изображений), а MSE — среднеквадратичная ошибка.
Применение к видеокодекам
PSNR используется для сравнения качества исходного и сжатого видео, оценивая уровень искажений, введенных процессом сжатия.
Преимущества
Простота вычисления и предоставление объективной меры качества.
Недостатки
Не всегда коррелирует с восприятием качества человеком, особенно при наличии сложных изображений или видимых артефактов.
Интерпретация значений
Чем выше PSNR (в дБ), тем меньше искажений и лучше качество видео.
Сравнение с другими метриками
В отличие от SSIM и MOS, PSNR может не отражать точное визуальное качество, но остается популярным из-за своей простоты и исторического использования.
Расчет для видео
PSNR вычисляется для каждого кадра и затем усредняется по всей последовательности видео.
Использование в практике
Часто используется в научных статьях и оценках кодеков, хотя в индустрии предпочтение может отдаваться более коррелирующим с человеческим восприятием метрикам.

Параметр
Описание
Определение
SSIM (Structural Similarity Index) — это метод оценки качества сжатия видео, измеряющий схожесть структуры между оригинальным и сжатым видео.
Формула
SSIM(L, C, S) = (L  C  S), 
где 
L — сходство по яркости, 
C — сходство по контрасту, 
S — сходство по структуре.
Применение к видеокодекам
SSIM оценивает, насколько хорошо сжатое видео сохраняет структурные характеристики оригинала.
Преимущества
Более точно отражает перцептивное качество (в восприятии человеком), чем PSNR, учитывая структурные особенности изображения.
Недостатки
Может не полностью коррелировать с человеческим восприятием в сложных сценах или при определенных искажениях.
Интерпретация значений
Чем ближе значение SSIM к 1, тем лучше качество сжатия.
Сравнение с другими метриками
В отличие от PSNR, SSIM лучше отражает визуальное качество, но может быть более сложным для вычисления.
Расчет для видео
SSIM вычисляется для каждого кадра и затем усредняется по всей исследуемой последовательности видео.
Использование в практике
Широко используется в научных исследованиях и промышленности для оценки качества видеокодеков.

Категория
Описание
Определение
VMAF (Video Multimethod Assessment Fusion) — метрика оценки качества сжатия видео, разработанная Netflix для оценки воспринимаемого качества сжатого видео. Она объединяет несколько объективных метрик для предоставления оценки, которая близко соответствует восприятию человека.
Расчет
VMAF не является простой математической формулой, как PSNR или SSIM. Он использует машинное обучение, основанное на большом наборе данных о субъективной оценке качества видео, для прогнозирования оценки качества на основе таких характеристик, как PSNR, SSIM, движение и т.д.
Применение
Используется для оценки качества видео в различных условиях сжатия, особенно в потоковой передаче видео.
Преимущества
- Высокая корреляция с восприятием человека
- Гибкость в отношении различных типов контента и условий просмотра
Недостатки
- Высокая вычислительная интенсивность
- Требует значительных ресурсов для расчета
Сравнение с другими метриками
Корреляция с человеческим восприятием выше, чем у MOS, PSNR и SSIM
- Более сложная метрика для расчета, чем PSNR и SSIM
Дополнительные сведения
VMAF постоянно развивается и совершенствуется, включая новые функции и улучшения для повышения точности оценки качества видео.

Параметр
Описание
Определение
VQM (Video Quality Metric) - это метрика качества видео, которая сочетает в себе объективные и субъективные методы оценки.
Метод расчета
VQM может включать анализ различных параметров, таких как битрейт, разрешение и артефакты сжатия. Он может использовать алгоритмы, которые оценивают различия между оригинальным и сжатым видео, учитывая тип контента (статичные сцены или сцены с движением).
Интерпретация
- Возможная шкала: VQM может использовать шкалу, аналогичную MOS (1–5), или нормализованную шкалу (0–100), в зависимости от реализации.
- Высокие значения: Как правило, более высокие значения VQM указывают на лучшее воспринимаемое качество видео.
- Пороговые значения: Могут существовать определённые пороги, определяющие уровни качества (например, значения выше определённого уровня считаются хорошими).
Преимущества
- Лучшая корреляция с восприятием человека по сравнению с PSNR или SSIM.
- Учитывает различные аспекты видео, включая содержание и движение.
Ограничения
- Может быть более вычислительно интенсивным, чем некоторые другие метрики.
- Отсутствие единого стандарта, что может привести к различиям в методах расчета.
Приложения
VQM широко используется в таких областях, как телевещание, потоковое видео и телекоммуникации, где важно обеспечить высокое качество видео при передаче.
#Сравнение VQM с другими метриками измерения качества сжатия
Метрика
Определение
Способ расчета
Тип
Преимущества
Недостатки
Приложения
Сравнение с другими метриками
VQM
Подробное описание VQM
Описание метода расчета
Субъективный
Высокая корреляция с восприятием человека
Затратный по времени и ресурсам
Телекоммуникации, видеоаналитика
Сравнение с MOS, DSPI, PSNR, SSIM, VMAF
MOS
Оценка качества видео на основе человеческого восприятия
Опрос участников
Субъективный
Прямое отражение человеческого восприятия
Субъективность, затраты времени
Телекоммуникации, аудио-видео качество
Более простой, но менее детальный чем VQM
DSPI
Сравнение двух видеофрагментов
Сравнительный тест
Субъективный
Уменьшает влияние субъективности
Затратный по времени
Оценка качества видео
Похож на VQM, но более простой
PSNR
Измеряет разницу между оригинальным и сжатым видео
Математическая формула
Объективный
Прост в расчете
Не всегда коррелирует с человеческим восприятием
Видеокомпрессия, изображение качество
Менее точный чем VQM и SSIM
SSIM
Измеряет структурное сходство между двумя изображениями
Математическая формула
Объективный
Лучше отражает человеческое восприятие чем PSNR
Сложнее в расчете
Видеоаналитика, изображение обработка
Более точный, но требует больше ресурсов чем PSNR
VMAF
Комбинированная метрика, использующая машинное обучение
Машинное обучение на основе нескольких метрик
Гибридный
Высокая корреляция с человеческим восприятием
Высокая вычислительная интенсивность
Потоковое видео, видеоаналитика
Более точный чем VQM, но требует больше ресурсов